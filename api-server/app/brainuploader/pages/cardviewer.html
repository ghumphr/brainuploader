<html>
<head><title>BrainUploader</title>
<link rel="stylesheet" href="css/style.css" />
</head>
<body>
    <!-- TODO: this should use a local copy or perhaps a trusted CDN with hash -->
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <div class="flashcard-container">
        <div class="flashcard question-side" style="display:none;">
            <h1>Q:</h1>
            <div class="question">
                <p>What is the capital of France?</p>
            </div>
        </div>
        <div class="flashcard answer-side" style="display:none;">
            <h1>A:</h1>
            <div class="answer">
                <p>Paris</p>
            </div>
        </div>
<table>
<tr> <td></td> <td> <button class="button flip-button">Flip</button> </td> <td></td> </tr>
<tr> <td>
<button class="button wrong-button">Wrong</button>
</td> <td></td> <td>
<button class="button right-button">Right</button>
</td> </tr>
<tr> <td></td> <td> <button class="button skip-button">Skip</button> </td> <td></td> </tr>
</table>
<!--        <button class="button edit-button">Edit</button>
        <button class="button new-button">New</button> -->
    </div>
    <script>

//////
// Global variables
//////

// This is the current stack of flashcards that the viewer is displaying
var current_stack = [];


/////
// Copied functions
//
// The below two functions were shamelessly copied from other sources and are included here with citations
// The rest of the code is my own original work except where other sources are cited
////

// Function to retrieve the value of a cookie
// source: written by Google Gemini
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}            

// Function to add days to date
// source: https://www.geeksforgeeks.org/how-to-add-days-to-date-in-javascript/
function addDays(date, days) {
    const newDate = new Date(date);
    newDate.setDate(date.getDate() + days);
    return newDate;
}


// Display the question for the flashcard at the top of the stack
function show_question()
{
//    alert("show_question() " + current_stack.length);
    if(current_stack.length > 0)
    {
//        alert(current_stack[0].front);
        $(".question").html(current_stack[0].front);
        $(".answer-side").hide();
        $(".question-side").show();
        $(".answer").html(current_stack[0].back);
    }
    else
    {
        cycle_cards();
    }
}

// Display the answer for the flashcard at the top of the stack
function show_answer()
{
    if(current_stack.length > 0)
    {
//        alert(current_stack[0].back);
        $(".answer").html(current_stack[0].back);
        $(".question-side").hide();
        $(".question").html(current_stack[0].back);
    }
    else
    {
        cycle_cards();
    }
}

// Handle callback from AJAX call retrieving flashcards for viewing
function process_flashcards(data, textStatus, jqXHR)
{
    current_stack = data;
    if(current_stack.length > 0)
    {
        show_question();
    }
    else
    {
        $(".answer").html("");
        $(".question-side").hide();
        $(".answer-side").show();
        $(".question").html("");
        alert("There are no flashcards left.");
    }
}


// Grab a new batch of cards from the server and start viewing them
function cycle_cards()
{
    $.ajax({
        dataType: "json",
        error: function(jqXHR, textStatus, errorThrown) { alert(textStatus); },
        timeout: 2000,
        type: "GET",
        url: "../api/flashcards/",
        success: process_flashcards
    });
}

// Mark the current card in the viewer wrong
function mark_current_card_wrong()
{
    if(current_stack.length > 0)
    {
        a = current_stack.shift();
        a.times_right_in_a_row = 0;
        var now = new Date();
        a.next_review = now.toISOString();
        current_stack.push(a);
        $.ajax({
            dataType: "json",
            error: function(jqXHR, textStatus, errorThrown) { alert(textStatus); },
            timeout: 2000,
            type: "PATCH",
            url: "../api/flashcards/" + a.id + "/",
            data: {
                'next_review': a.next_review,
                'times_right_in_a_row': a.times_right_in_a_row
            },
            headers: {
                "X-CSRFToken": getCookie("csrftoken")
            },
            success: show_question
        });
    }
    else
    {
        show_question();
    }
}

// Mark the current card in the viewer right
function mark_current_card_right()
{
    if(current_stack.length > 0)
    {
        a = current_stack.shift();
        a.times_right_in_a_row = a.times_right_in_a_row + 1;
        var now = new Date();
        a.next_review = (addDays(now, 2 ** (a.times_right_in_a_row - 1) - 1)).toISOString();
        if(a <= 1)
        {
            current_stack.push(a);
        }
        $.ajax({
            dataType: "json",
            error: function(jqXHR, textStatus, errorThrown) { alert(textStatus); },
            timeout: 2000,
            type: "PATCH",
            url: "../api/flashcards/" + a.id + "/",
            data:
            {
                'next_review': a.next_review,
                'times_right_in_a_row': a.times_right_in_a_row
            },
            headers:
            {
                "X-CSRFToken": getCookie("csrftoken")
            },
            success: show_question
        });
    }
    else
    {
        show_question();
    }
}

// Flip the current card in the viewer to display the other side
function flip_current_card()
{
    $(".question-side, .answer-side").toggle();
}

// Skip the current card, putting it on the back of the currently displayed stack
function skip_current_card()
{
    if(current_stack.length > 0)
    {
        a = current_stack.shift();
        current_stack.push(a);
    }
    show_question();
}


// This runs after the page has completely loaded
$(document).ready(function() {

    // Set up button handlers
    $(".flip-button").click(flip_current_card);
    $(".skip-button").click(skip_current_card);
    $(".wrong-button").click(mark_current_card_wrong);
    $(".right-button").click(mark_current_card_right);

    // Once the app is ready, grab some cards and display them
    cycle_cards();
    
});

    </script>
</body>
</html>

